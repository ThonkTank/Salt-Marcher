#!/bin/bash
# Pre-commit hook for Salt Marcher plugin
# Validates code quality before allowing commits

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

PLUGIN_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
CONFIG_FILE="$PLUGIN_ROOT/.devkitrc.json"

# Load configuration
if [ -f "$CONFIG_FILE" ]; then
  # Parse JSON config (simple approach)
  RUN_TESTS=$(grep -o '"precommit_tests"[[:space:]]*:[[:space:]]*\(true\|false\)' "$CONFIG_FILE" | grep -o 'true\|false')
  RUN_UI_VALIDATION=$(grep -o '"precommit_ui_validation"[[:space:]]*:[[:space:]]*\(true\|false\)' "$CONFIG_FILE" | grep -o 'true\|false')
  RUN_LINT=$(grep -o '"precommit_lint"[[:space:]]*:[[:space:]]*\(true\|false\)' "$CONFIG_FILE" | grep -o 'true\|false')
else
  # Default configuration
  RUN_TESTS="true"
  RUN_UI_VALIDATION="false"
  RUN_LINT="false"
fi

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}Pre-commit Validation${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

FAILED=0

# 1. Run unit tests
if [ "$RUN_TESTS" = "true" ]; then
  echo -e "\n${YELLOW}[1/3]${NC} Running unit tests..."
  cd "$PLUGIN_ROOT" || exit 1

  if npm test 2>&1 | grep -q "FAIL"; then
    echo -e "${RED}✗ Tests failed${NC}"
    FAILED=1
  else
    echo -e "${GREEN}✓ Tests passed${NC}"
  fi
fi

# 2. Run UI validation
if [ "$RUN_UI_VALIDATION" = "true" ]; then
  echo -e "\n${YELLOW}[2/3]${NC} Validating UI..."

  # Check if plugin is running
  if [ -S "$PLUGIN_ROOT/../../ipc.sock" ]; then
    if ./devkit/core/cli/devkit validate-ui all &>/dev/null; then
      echo -e "${GREEN}✓ UI validation passed${NC}"
    else
      echo -e "${RED}✗ UI validation failed${NC}"
      FAILED=1
    fi
  else
    echo -e "${YELLOW}⚠ Plugin not running, skipping UI validation${NC}"
  fi
fi

# 3. Run linter
if [ "$RUN_LINT" = "true" ]; then
  echo -e "\n${YELLOW}[3/3]${NC} Running linter..."

  if npm run lint &>/dev/null; then
    echo -e "${GREEN}✓ Lint passed${NC}"
  else
    echo -e "${YELLOW}⚠ Lint warnings (not blocking)${NC}"
  fi
fi

echo -e "\n${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

# Summary
if [ $FAILED -eq 0 ]; then
  echo -e "${GREEN}✅ Pre-commit validation passed${NC}"
  echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  exit 0
else
  echo -e "${RED}❌ Pre-commit validation failed${NC}"
  echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "\n${YELLOW}Tip: Fix the errors above or use 'git commit --no-verify' to skip${NC}"
  exit 1
fi
